<div :class="getStyles()" class="max-h-[90vh] overflow-y-auto" role="document" x-data="Challenge" x-init='id = {{ challenge.id }}; max_attempts = {{ max_attempts }}; attempts = {{ attempts }}; ratingValue = {{ (rating.get('value') if rating else None) | tojson }}; ratingReview = {{ (rating.get('review', '') if rating else None) | tojson }};'>
  <div class="bg-white rounded-xl shadow-2xl overflow-hidden" @click.outside="closeModal()">
    <div class="p-6 sm:p-8">

      <div class="relative mb-6">
        <button type="button" class="absolute top-0 right-0 w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition-all duration-200 text-xl font-light" data-bs-dismiss="modal" aria-label="Close" @click.prevent="closeModal()">
          <i class="fas fa-times"></i>
        </button>

        <ul class="flex border-b-2 border-gray-100 gap-0 -mb-px nav nav-tabs" role="tablist">
          <li class="nav-item">
            <button id="challenge-tab" type="button" data-bs-toggle="tab" class="nav-link px-6 py-3 border-b-2 border-blue-600 text-blue-600 font-semibold transition-colors duration-200 relative -mb-0.5 active" data-bs-target="#challenge" role="tab" aria-controls="challenge" aria-selected="true" @click="showChallenge()">
              {% trans %}Challenge{% endtrans %}
            </button>
          </li>

          {% block submissions %}
            {% if Configs.view_self_submissions %}
            <li class="nav-item">
              <button id="submissions-tab" type="button" data-bs-toggle="tab" class="nav-link px-6 py-3 border-b-2 border-transparent text-gray-600 hover:text-gray-900 hover:border-gray-300 font-medium transition-all duration-200 challenge-submissions" data-bs-target="#submissions" role="tab" aria-controls="submissions" aria-selected="false" @click="showSubmissions()">
                {% if solves != None %}
                  Submissions
                {% endif %}
              </button>
            </li>
            {% endif %}
          {% endblock %}

          {% block solution %}
            {% if challenge.solution_id %}
            <li class="nav-item" x-show="getSolutionId()">
              <button id="solution-tab" type="button" data-bs-toggle="tab" class="nav-link px-6 py-3 border-b-2 border-transparent text-gray-600 hover:text-gray-900 hover:border-gray-300 font-medium transition-all duration-200 challenge-solution" data-bs-target="#solution" role="tab" aria-controls="solution" aria-selected="false" @click="showSolution()">
                {% trans %}Solution{% endtrans %}
              </button>
            </li>
            {% endif %}
          {% endblock %}

          {% block solves %}
            {% if solves != None %}
            <li class="nav-item">
              <button id="solves-tab" type="button" data-bs-toggle="tab" class="nav-link px-6 py-3 border-b-2 border-transparent text-gray-600 hover:text-gray-900 hover:border-gray-300 font-medium transition-all duration-200 challenge-solves" data-bs-target="#solves" role="tab" aria-controls="solves" aria-selected="false" @click="showSolves()">
                  {{ ngettext("%(num)d Solve", "%(num)d Solves", solves) }}
              </button>
            </li>
            {% endif %}
          {% endblock %}
        </ul>
      </div>

      <div class="tab-content">
        <div class="tab-pane show active" role="tabpanel" id="challenge" aria-labelledby="challenge-tab">
            <div class="text-center mb-8">
              <h2 class="challenge-name text-4xl font-bold text-gray-900 mb-3">
                {{ challenge.name }}
              </h2>
              <div class="inline-flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-2 rounded-full shadow-lg">
                <i class="fas fa-coins"></i>
                <h3 class="challenge-value text-xl font-bold">
                  {{ challenge.value }} {% trans %}points{% endtrans %}
                </h3>
              </div>
            </div>

            {% if tags %}
              <div class="challenge-tags text-center mb-6 flex flex-wrap justify-center gap-2">
                {% block tags %}
                  {% for tag in tags %}
                    <span class="challenge-tag inline-flex items-center bg-blue-50 text-blue-700 px-4 py-1.5 rounded-full text-sm font-semibold border border-blue-200 shadow-sm hover:bg-blue-100 transition-colors">{{ tag }}</span>
                  {% endfor %}
                {% endblock %}
              </div>
            {% endif %}

            <div class="text-center mb-6">
              <small class="challenge-attribution text-gray-500 text-sm">
                {% block attribution %}{{ challenge.byline }}{% endblock %}
              </small>

              {% if Configs.challenge_ratings == "public" %}
              <div class="challenge-ratings mt-3 flex items-center justify-center gap-2">
                {% block ratings %}
                  {% if ratings.average %}
                    <span class="text-gray-700 font-semibold">{{ ratings.average }}</span>
                    <div class="flex gap-0.5">
                    {% for _ in range((ratings.average | round(0) | int)) %}
                      <i class="fa-solid fa-star text-yellow-400 text-sm"></i>
                    {% endfor %}
                    </div>
                    <span class="text-gray-500 text-sm">{{ ratings.count }} {% trans c=ratings.count %}rating{% pluralize %}ratings{% endtrans %}</span>
                  {% endif %}
                {% endblock %}
              </div>
              {% endif %}
            </div>

            <div class="challenge-desc prose prose-lg max-w-none mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
              {% block description %}{{ challenge.html }}{% endblock %}
            </div>

            {% if challenge.connection_info %}
              <div class="mb-6">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <div class="flex items-start gap-3">
                    <i class="fas fa-link text-blue-600 mt-1"></i>
                    <div class="challenge-connection-info flex-1">
                      {% block connection_info %}
                        {% set conn = challenge.connection_info %}
                        {% if not conn %}
                        {% elif conn.startswith("http") %}
                          {{ conn | urlize(target="_blank") }}
                        {% else %}
                          <code class="bg-white px-3 py-1 rounded border border-blue-200 text-blue-800 font-mono text-sm">{{ conn }}</code>
                        {% endif %}
                      {% endblock %}
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}

            {% if hints %}
              <div class="challenge-hints mb-8">
                <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                  <i class="fas fa-lightbulb text-yellow-500"></i>
                  {% trans %}Hints{% endtrans %}
                </h4>
                <div class="space-y-3">
                {% for hint in hints | sort(attribute="cost") %}
                  <div x-data="Hint" x-init="id = {{ hint.id }}" class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition-shadow">
                    {% if hint.content %}
                    <details class="group">
                      <summary class="px-4 py-3 bg-gray-50 hover:bg-gray-100 cursor-pointer font-medium text-gray-700 flex items-center justify-between transition-colors">
                        <span class="flex items-center gap-2">
                          <i class="fas fa-chevron-right text-xs transform transition-transform group-open:rotate-90"></i>
                          {% trans %}View Hint{% endtrans %}{% if hint.title %}: {{ hint.title }}{% endif %}
                        </span>
                      </summary>
                      <div class="px-4 py-3 bg-white border-t border-gray-200">{{ hint.html | safe }}</div>
                    </details>
                    {% else %}
                    <details @toggle="showHint(event)" class="group">
                      <summary class="px-4 py-3 bg-gray-50 hover:bg-gray-100 cursor-pointer font-medium text-gray-700 flex items-center justify-between transition-colors">
                        <span class="flex items-center gap-2">
                          <i class="fas fa-chevron-right text-xs transform transition-transform group-open:rotate-90"></i>
                          {% if hint.title %}
                          {{ hint.title }} <span class="text-blue-600 font-semibold">(Cost: {{ hint.cost }} point{{ hint.cost|pluralize }})</span>
                          {% else %}
                          Unlock Hint <span class="text-blue-600 font-semibold">({{ hint.cost }} point{{ hint.cost|pluralize }})</span>
                          {% endif %}
                        </span>
                        <i class="fas fa-lock text-gray-400"></i>
                      </summary>
                      <div class="px-4 py-3 bg-white border-t border-gray-200" x-html="html"></div>
                    </details>
                    {% endif %}
                  </div>
                {% endfor %}
                </div>
              </div>
            {% endif %}

            {% if files %}
              <div class="challenge-files mb-8">
                <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                  <i class="fas fa-download text-blue-600"></i>
                  {% trans %}Files{% endtrans %}
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                {% for file in files %}
                  <div class="file-button-wrapper">
                    {% set segments = file.split('/') %}
                    {% set token = file.split('?') | last %}
                    {% if token %}
                      {% set filename = segments | last | replace("?" + token, "") %}
                    {% else %}
                      {% set filename = segments | last %}
                    {% endif %}
                    <a
                        class="inline-flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-4 py-3 rounded-lg transition-all duration-200 w-full shadow-md hover:shadow-lg transform hover:-translate-y-0.5"
                        href="{{ file }}"
                        title="{{ filename }}"
                    >
                      <i class="fas fa-download"></i>
                      <span class="truncate font-medium text-sm">
                        {{ filename }}
                      </span>
                    </a>
                  </div>
                {% endfor %}
                </div>
              </div>
            {% endif %}

            <template x-if="max_attempts > 0">
              <div class="mb-6 flex items-center justify-center">
                <div class="inline-flex items-center gap-2 bg-yellow-50 border border-yellow-200 rounded-lg px-4 py-2">
                  <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                  <p class="text-sm font-semibold text-yellow-800">
                    <span x-text="attempts" class="font-bold"></span>/<span x-text="max_attempts" class="font-bold"></span> {% trans c=max_attempts %}attempt{% pluralize %}attempts{% endtrans %}
                  </p>
                </div>
              </div>
            </template>

            <div class="submit-row bg-gray-50 rounded-xl p-6 border border-gray-200 shadow-sm">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="sm:col-span-2">
                  {% block input %}
                    <input
                        id="challenge-id" class="challenge-id" type="hidden"
                        value="{{ challenge.id }}"
                    >
                    <div class="relative">
                      <input
                          id="challenge-input" class="challenge-input w-full pl-32 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all font-mono text-sm bg-white"
                          type="text" name="submission"
                          @keyup.enter="submitChallenge()"
                          placeholder="{% trans %}Enter flag...{% endtrans %}" x-model="submission"
                      >
                    </div>
                  {% endblock %}
                </div>

                <div class="key-submit">
                  {% block submit %}
                    <button
                        id="challenge-submit"
                        class="challenge-submit w-full px-6 py-3 bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-800 hover:to-gray-900 text-white rounded-lg transition-all duration-200 font-semibold shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center justify-center gap-2" type="submit"
                        @click.debounce.500ms="submitChallenge()"
                    >
                      <i class="fas fa-paper-plane"></i>
                      {% trans %}Submit{% endtrans %}
                    </button>
                  {% endblock %}
                </div>
              </div>
            </div>

            <div class="notification-row mt-6">
              <div class="">
                <template x-if="response">
                  {# This alert is re-used for all alerts, so it's important not to make it dismissible #}
                  <div class="text-center w-full p-6 rounded-xl shadow-lg border-2 animate-fade-in"
                      :class="{
                        'bg-gradient-to-r from-green-50 to-green-100 text-green-900 border-green-400': response.data.status == 'correct',
                        'bg-gradient-to-r from-blue-50 to-blue-100 text-blue-900 border-blue-400': response.data.status == 'already_solved',
                        'bg-gradient-to-r from-red-50 to-red-100 text-red-900 border-red-400': response.data.status == 'incorrect',
                        'bg-gradient-to-r from-yellow-50 to-yellow-100 text-yellow-900 border-yellow-400': response.data.status == 'paused',
                      }" role="alert"
                  >
                    <div class="flex items-center justify-center gap-3 mb-2">
                      <i :class="{
                        'fas fa-check-circle text-2xl': response.data.status == 'correct' || response.data.status == 'already_solved',
                        'fas fa-times-circle text-2xl': response.data.status == 'incorrect',
                        'fas fa-pause-circle text-2xl': response.data.status == 'paused',
                      }"></i>
                      <strong class="text-lg font-bold" x-text="response.data.message"></strong>
                    </div>
                    <div x-show="(response.data.status == 'correct' || response.data.status == 'already_solved')" class="mt-4">
                      <div x-show="getNextId()" class="mb-4">
                        <button @click="nextChallenge()" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-lg transition-all duration-200 font-semibold shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                          <span>{% trans %}Next Challenge{% endtrans %}</span>
                          <i class="fas fa-arrow-right"></i>
                        </button>
                      </div>

                      {% if Configs.social_shares %}
                      <div class="mt-6 pt-4 border-t-2 border-current border-opacity-20">
                        <button x-show="!share_url" @click="getShareUrl()" class="inline-flex items-center gap-2 px-4 py-2 bg-white hover:bg-gray-50 text-current rounded-lg transition-all font-medium shadow-sm border-2 border-current border-opacity-30">
                          <i class="fas fa-share-alt"></i>
                          {% trans %}Share{% endtrans %}
                        </button>
                        <div class="flex items-center justify-center gap-3 mt-4" role="group" x-show="share_url">
                          <button type="button" class="w-10 h-10 flex items-center justify-center border-2 border-current border-opacity-30 hover:bg-white hover:border-opacity-50 rounded-lg transition-all shadow-sm" @click="copyShareUrl()" data-bs-toggle="tooltip" data-bs-title="Copied!">
                            <i class="fa-solid fa-copy"></i>
                          </button>
                          <a :href="'https://twitter.com/intent/tweet?url=' + encodeURIComponent(share_url)" role="button" class="w-10 h-10 flex items-center justify-center border-2 border-current border-opacity-30 hover:bg-white hover:border-opacity-50 rounded-lg transition-all shadow-sm" target="_blank">
                            <i class="fa-brands fa-twitter"></i>
                          </a>
                          <a :href="'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(share_url)" role="button" class="w-10 h-10 flex items-center justify-center border-2 border-current border-opacity-30 hover:bg-white hover:border-opacity-50 rounded-lg transition-all shadow-sm" target="_blank">
                            <i class="fa-brands fa-facebook-f"></i>
                          </a>
                          <a :href="'http://www.linkedin.com/shareArticle?url=' + encodeURIComponent(share_url)" role="button" class="w-10 h-10 flex items-center justify-center border-2 border-current border-opacity-30 hover:bg-white hover:border-opacity-50 rounded-lg transition-all shadow-sm" target="_blank">
                            <i class="fa-brands fa-linkedin-in"></i>
                          </a>
                        </div>
                      </div>
                      {% endif %}

                      {% if Configs.challenge_ratings != "disabled" %}
                      <div class="mt-6 pt-6 border-t-2 border-current border-opacity-20">
                        <div class="text-center max-w-md mx-auto">
                          <p class="mb-4 font-semibold text-lg">{% trans %}Rate this challenge:{% endtrans %}</p>
                          <div class="rating-stars mb-6 flex justify-center gap-2" x-init="selectedRating = ratingValue || 0;">
                            <template x-for="star in [1,2,3,4,5]" :key="star">
                              <i 
                                class="fa-solid fa-star rating-star text-3xl cursor-pointer transform transition-all duration-200 hover:scale-110" 
                                :class="star <= (hoveredRating || selectedRating || 0) ? 'text-yellow-400 drop-shadow-md' : 'text-gray-300'"
                                @mouseover="hoveredRating = star"
                                @mouseleave="hoveredRating = 0"
                                @click="selectedRating = star"
                              ></i>
                            </template>
                          </div>
                          <div class="mb-4">
                            <textarea 
                              class="w-full px-4 py-3 border-2 border-current border-opacity-30 rounded-lg focus:outline-none focus:ring-2 focus:ring-current focus:border-opacity-50 bg-white text-gray-900 placeholder-gray-500 transition-all" 
                              rows="3" 
                              x-model="ratingReview"
                              placeholder="{% trans %}Write a review (optional){% endtrans %}"
                              maxlength="2000"
                            ></textarea>
                          </div>
                          <div class="mb-2">
                            <button 
                              @click="submitRating()"
                              class="px-6 py-2.5 bg-white hover:bg-gray-50 text-current rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all font-semibold shadow-sm border-2 border-current border-opacity-30"
                              :disabled="!selectedRating"
                            >
                              {% trans %}Submit Rating{% endtrans %}
                            </button>
                          </div>
                          <div x-show="ratingSubmitted" class="text-current mt-3 font-medium">
                            <i class="fas fa-check-circle mr-2"></i>
                            {% trans %}Thank you for your rating!{% endtrans %}
                          </div>
                        </div>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <div class="tab-pane" role="tabpanel" id="submissions" aria-labelledby="submissions-tab" style="display: none;">
            <div class="py-6">
              <div class="overflow-hidden rounded-xl border border-gray-200 shadow-sm">
                <table class="w-full border-collapse">
                  <thead class="bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-200">
                  <tr>
                    <th class="px-6 py-4 font-bold text-gray-700 text-left">{% trans %}Submission{% endtrans %}</th>
                    <th class="px-6 py-4 font-bold text-gray-700 text-center">{% trans %}Type{% endtrans %}</th>
                    <th class="px-6 py-4 font-bold text-gray-700 text-center">{% trans %}Date{% endtrans %}</th>
                  </tr>
                  </thead>
                  <tbody id="challenge-submission-names" class="bg-white divide-y divide-gray-200">
                  <template x-for="submission in submissions">
                    <tr class="hover:bg-blue-50 transition-colors duration-150">
                      <td class="px-6 py-4" x-data="{ truncate: true }">
                        <div class="flex items-center gap-3">
                          <code x-text="truncate ? '*'.repeat(submission.provided.length) : submission.provided" class="bg-gray-100 px-3 py-1.5 rounded-lg text-sm font-mono border border-gray-200 flex-1"></code>
                          <button class="text-blue-600 hover:text-blue-800 transition-colors p-2 hover:bg-blue-100 rounded-lg" @click="truncate = !truncate" title="Toggle visibility">
                            <i :class="truncate ? 'fas fa-eye' : 'fas fa-eye-slash'"></i>
                          </button>
                        </div>
                      </td>
                      <td class="px-6 py-4 text-center">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold" 
                              :class="{
                                'bg-green-100 text-green-800': submission.type === 'correct',
                                'bg-red-100 text-red-800': submission.type === 'incorrect',
                                'bg-gray-100 text-gray-800': submission.type !== 'correct' && submission.type !== 'incorrect'
                              }"
                              x-text="submission.type"></span>
                      </td>
                      <td class="px-6 py-4 text-center text-gray-600" x-text="submission.date"></td>
                    </tr>
                  </template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="tab-pane" role="tabpanel" id="solves" aria-labelledby="solves-tab" style="display: none;">
            <div class="py-6">
              <div class="overflow-hidden rounded-xl border border-gray-200 shadow-sm">
                <table class="w-full border-collapse">
                  <thead class="bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-200">
                  <tr>
                    <th class="px-6 py-4 font-bold text-gray-700 text-left">{% trans %}Name{% endtrans %}</th>
                    <th class="px-6 py-4 font-bold text-gray-700 text-center">{% trans %}Date{% endtrans %}</th>
                  </tr>
                  </thead>
                  <tbody id="challenge-solves-names" class="bg-white divide-y divide-gray-200">
                  <template x-for="solve in solves">
                    <tr class="hover:bg-blue-50 transition-colors duration-150">
                      <td class="px-6 py-4">
                        <a :href="solve.account_url" x-text="solve.name" class="text-blue-600 hover:text-blue-800 font-semibold hover:underline transition-colors flex items-center gap-2">
                          <i class="fas fa-user-circle text-gray-400"></i>
                          <span x-text="solve.name"></span>
                        </a>
                      </td>
                      <td class="px-6 py-4 text-center text-gray-600" x-text="solve.date"></td>
                    </tr>
                  </template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="tab-pane" role="tabpanel" id="solution" aria-labelledby="solution-tab" style="display: none;">
            <div class="py-6">
              <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200 p-8 shadow-sm">
                <div class="flex items-center gap-3 mb-6">
                  <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-lightbulb text-white text-xl"></i>
                  </div>
                  <h3 class="text-2xl font-bold text-gray-900">{% trans %}Solution{% endtrans %}</h3>
                </div>
                <div class="challenge-solution-content bg-white rounded-lg p-6 border border-blue-200 shadow-sm">
                  <template x-if="solution">
                    <div x-html="solution" class="prose prose-lg max-w-none" style="white-space: pre-wrap;">
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>
